<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Crear Solicitud - Duit</title>
    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Header -->
    <div th:replace="~{components/headerUsuario::headerUsuario}"></div>

    <!-- Contenido -->
    <main class="flex-grow-1 bg-light">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">

                    <!-- Consejos -->
                    <div th:replace="~{components/consejosCrearSolicitud::consejosCrearSolicitud}"></div>

                    <!-- Formulario -->
                    <div class="card shadow">
                        <!-- Titulo  Editar o Crear -->
                        <div class="card-header bg-primary text-white">
                            <h1 class="card-title mb-0">
                                <!-- Editar -->
                                <span th:if="${isEditing != null and isEditing}">
                                    <i class="bi bi-pencil-square"></i>
                                    Editar Solicitud
                                </span>
                                <!-- Crear -->
                                <span th:unless="${isEditing != null and isEditing}">
                                    <i class="bi bi-plus-circle"></i>
                                    Crear Nueva Solicitud
                                </span>
                            </h1>
                            <p class="mb-0 mt-2">
                                <!-- Texto editar -->
                                <span th:if="${isEditing != null and isEditing}">
                                    Modifica los datos de tu solicitud
                                </span>
                                <!-- Texto crear -->
                                <span th:unless="${isEditing != null and isEditing}">
                                    Describe el servicio que necesitas y profesionales se pondrán en contacto contigo
                                </span>
                            </p>
                        </div>
                        <!-- Cuerpo -->
                        <div class="card-body">

                            <!-- Errores -->
                            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span th:text="${error}">Error message</span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>

                            <!-- Form -->
                            <form
                                th:action="${isEditing != null and isEditing} ? @{'/jobs/editar/' + ${editingId}} : @{/jobs/crear}"
                                method="POST">

                                <!-- Banner edicion -->
                                <div th:if="${isEditing != null and isEditing}" class="alert alert-warning mb-4">
                                    <i class="bi bi-pencil-square"></i>
                                    <strong>Editando solicitud:</strong>
                                    Realiza los cambios necesarios y guarda.
                                    <a th:href="@{/jobs/mis-solicitudes}" class="btn btn-sm btn-outline-secondary ms-2">
                                        <i class="bi bi-x"></i>
                                        Cancelar edición
                                    </a>
                                </div>

                                <!-- Titulo -->
                                <div class="mb-4">
                                    <label for="title" class="form-label fw-bold">
                                        <i class="bi bi-pencil text-primary"></i> Título de tu solicitud *
                                    </label>
                                    <input type="text" name="title" th:value="${serviceRequest?.title}"
                                        class="form-control form-control-lg" id="title"
                                        placeholder="Ej: Reparación de tubería en cocina" maxlength="150" required>
                                    <div class="form-text">
                                        Sé específico y claro.
                                    </div>
                                </div>

                                <!-- Categoria -->
                                <div class="mb-4">
                                    <label for="categoryId" class="form-label fw-bold">
                                        <i class="bi bi-tag text-primary"></i> Categoría del servicio *
                                    </label>
                                    <select name="categoryId" id="categoryId" class="form-select form-select-lg"
                                        required>
                                        <option value="">Selecciona una categoría</option>
                                        <option th:each="category : ${categories}" th:value="${category.id}"
                                            th:text="${category.name}"
                                            th:selected="${serviceRequest != null and serviceRequest.category != null and serviceRequest.category.id == category.id}">
                                        </option>
                                    </select>
                                    <div class="form-text">
                                        Selecciona la categoría más adecuada.
                                    </div>
                                </div>

                                <!-- Descripcion -->
                                <div class="mb-4">
                                    <label for="description" class="form-label fw-bold">
                                        <i class="bi bi-card-text text-primary"></i> Descripción detallada *
                                    </label>
                                    <textarea name="description" th:text="${serviceRequest?.description}"
                                        class="form-control" id="description" rows="6" maxlength="2000"
                                        placeholder="Describe en detalle qué necesitas:&#10;- ¿Cuál es el problema?&#10;- ¿Dónde está ubicado?&#10;- ¿Cuándo necesitas que se haga?&#10;- ¿Alguna preferencia especial?"
                                        required></textarea>
                                    <div class="form-text">
                                        Describe en detalle lo que necesitas.
                                    </div>
                                </div>

                                <!-- Fecha -->
                                <div class="mb-4">
                                    <label for="deadline" class="form-label fw-bold">
                                        <i class="bi bi-calendar text-primary"></i> ¿Cuándo lo necesitas? (opcional)
                                    </label>
                                    <input type="date" name="deadline"
                                        th:value="${serviceRequest?.deadline != null ? #temporals.format(serviceRequest.deadline, 'yyyy-MM-dd') : ''}"
                                        class="form-control" id="deadline">
                                    <div class="form-text">
                                        <i class="bi bi-clock"></i>
                                        Déjalo vacío si no tienes prisa o si es flexible
                                    </div>
                                </div>

                                <!-- Dirección del servicio -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-geo-alt text-primary"></i> Dirección donde realizar el servicio
                                        *
                                    </label>

                                    <!-- Opciones de dirección -->
                                    <div class="card border-light mb-3">
                                        <div class="card-body">
                                            <!-- Dirección habitual -->
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="addressOption"
                                                    id="habitualAddress" value="habitual"
                                                    th:checked="${serviceRequest == null or !serviceRequest.hasSpecificServiceAddress()}"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#specificAddressFields.show">
                                                <label class="form-check-label fw-bold" for="habitualAddress">
                                                    <i class="bi bi-house-door"></i> Usar mi dirección habitual
                                                </label>
                                                <div th:if="${user?.address != null}" class="form-text ms-4">
                                                    <i class="bi bi-info-circle text-muted"></i>
                                                    <span th:text="${user.address.fullAddress}">Dirección actual del
                                                        usuario</span>
                                                </div>
                                                <div th:unless="${user?.address != null}"
                                                    class="form-text ms-4 text-warning">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    No tienes dirección configurada. <a href="/profile/editar"
                                                        class="link-warning">Añádela en tu perfil</a>
                                                </div>
                                            </div>

                                            <!-- Dirección específica -->
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="addressOption"
                                                    id="specificAddress" value="specific"
                                                    th:checked="${serviceRequest != null and serviceRequest.hasSpecificServiceAddress()}"
                                                    data-bs-toggle="collapse" data-bs-target="#specificAddressFields">
                                                <label class="form-check-label fw-bold" for="specificAddress">
                                                    <i class="bi bi-pin-map"></i> Especificar otra dirección
                                                </label>
                                                <div class="form-text ms-4">
                                                    <i class="bi bi-info-circle text-muted"></i>
                                                    Si el servicio se realizará en una dirección diferente a la tuya
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Campos de dirección específica -->
                                    <div id="specificAddressFields" class="collapse"
                                        th:classappend="${serviceRequest != null and serviceRequest.hasSpecificServiceAddress()} ? 'show' : ''">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <label for="address" class="form-label">Calle y número *</label>
                                                <input type="text" name="serviceAddress.address"
                                                    th:value="${serviceRequest?.serviceAddress?.address}"
                                                    class="form-control" id="address"
                                                    placeholder="Ej: Calle Mayor, 123">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="city" class="form-label">Ciudad *</label>
                                                <input type="text" name="serviceAddress.city"
                                                    th:value="${serviceRequest?.serviceAddress?.city}"
                                                    class="form-control" id="city" placeholder="Ej: Madrid">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="postalCode" class="form-label">Código postal *</label>
                                                <input type="text" name="serviceAddress.postalCode"
                                                    th:value="${serviceRequest?.serviceAddress?.postalCode}"
                                                    class="form-control" id="postalCode" placeholder="Ej: 28001"
                                                    pattern="[0-9]{5}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="province" class="form-label">Provincia *</label>
                                                <input type="text" name="serviceAddress.province"
                                                    th:value="${serviceRequest?.serviceAddress?.province}"
                                                    class="form-control" id="province" placeholder="Ej: Madrid">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="country" class="form-label">País *</label>
                                                <input type="text" name="serviceAddress.country"
                                                    th:value="${serviceRequest?.serviceAddress?.country ?: 'España'}"
                                                    class="form-control" id="country" placeholder="España" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Info -->
                                <div class="alert alert-info mb-4" th:unless="${isEditing != null and isEditing}">
                                    <h6><i class="bi bi-lightbulb"></i> ¿Qué pasa después?</h6>
                                    <ol class="mb-0">
                                        <li>Tu solicitud se guardará como <strong>borrador</strong></li>
                                        <li>Podrás revisarla y <strong>publicarla</strong> cuando esté lista</li>
                                        <li>Los profesionales verán tu solicitud y te enviarán
                                            <strong>propuestas</strong>
                                        </li>
                                        <li>Podrás <strong>comparar</strong> y elegir la mejor propuesta</li>
                                    </ol>
                                </div>

                                <!-- Botones -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                    <!-- Volver -->
                                    <a th:href="${isEditing != null and isEditing} ? '/jobs/mis-solicitudes' : '/home'"
                                        class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i>
                                        <!-- Texto volver -->
                                        <span th:if="${isEditing != null and isEditing}">
                                            Volver a Mis Solicitudes
                                        </span>
                                        <span th:unless="${isEditing != null and isEditing}">
                                            Volver al Dashboard
                                        </span>
                                    </a>

                                    <!-- Enviar -->
                                    <button type="submit" class="btn btn-primary btn-lg px-4">
                                        <!-- Texto actualizar -->
                                        <span th:if="${isEditing != null and isEditing}">
                                            <i class="bi bi-check-circle"></i>
                                            Actualizar Solicitud
                                        </span>
                                        <!-- Texto crear -->
                                        <span th:unless="${isEditing != null and isEditing}">
                                            <i class="bi bi-save"></i>
                                            Crear Solicitud
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div th:replace="~{components/footerPublico::footerPublico}"></div>

    <!-- JavaScript Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>


</body>

</html>